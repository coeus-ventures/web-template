# Create/Reset Admin User for Web-Template Projects

## Overview

This feature allows users in the Behave application to create or reset an admin user account for their web-template project running in a MorphCloud sandbox. The admin user is created via a temporary script that is executed via SSH and automatically removed after execution.

## Context

- **Behave**: Parent application that manages projects
- **Web-Template**: Child application that runs in an iframe within Behave
- **Sandbox**: Each project in Behave has a MorphCloud sandbox where web-template runs
- **Admin Access**: Web-template needs an admin user to access `/admin` routes

## Goal

Enable Behave users to create/reset the admin password for their web-template without requiring local scripts or manual SSH access.

---

## Complete Flow

### 1. User Interface (Behave)

**Location**: Preview toolbar (when viewing `/admin` route)

**Button Visibility**:

- "Admin Access" button appears only when:
  - Preview is showing the `/admin` route of web-template
  - Project has an active sandbox with `instanceId`

**User Interaction**:

- User clicks "Admin Access" button
- Modal opens showing:
  - User's email (from Behave session)
  - Password input field
  - Confirm password input field
  - Submit button

### 2. Backend Process (Action)

When user submits the form:

**Step 1: Validation**

- Verify user is authenticated
- Validate password (minimum 8 characters)
- Verify password and confirmation match

**Step 2: Get Sandbox**

- Fetch project by `projectId`
- Get `sandbox.instanceId` from project
- Verify sandbox is available

**Step 3: Create Temporary Script**

- Generate unique filename: `create-admin-{timestamp}-{random}.ts`
- Create TypeScript script content that:
  - Imports `auth` and `db` from web-template
  - Checks if user with email already exists
  - If exists: Updates to admin role with new password
  - If not exists: Creates new admin user
  - Uses email from Behave user
  - Uses provided password

**Step 4: Execute via SSH**

- Connect to sandbox via MorphCloud SSH
- Create `/root/main/scripts` directory if it doesn't exist
- Write script to sandbox
- Execute: `bun /root/main/scripts/create-admin-{id}.ts`
- Wait for execution

**Step 5: Cleanup**

- Remove script from sandbox after execution
- Close SSH connection
- On error, attempt to remove script anyway

**Step 6: Return Result**

- On success: Return `{ success: true, email, password }`
- On error: Return `{ success: false, error: "message" }`

### 3. Credentials Display

After successful execution:

- Modal switches to credentials screen
- Displays:
  - Email (readonly, with copy button)
  - Password (readonly, with copy button)
- Warning message: "Copy these credentials and use to login at /auth/signin"
- "Done" button to close

### 4. Manual Login

- User copies email and password
- Navigates to `/auth/signin` in preview
- Logs in with credentials
- Now has access to `/admin` routes in web-template

---

## File Structure

### In Behave:

```
app/client/project/[id]/preview/
  behaviors/
    create-admin-user/
      actions/
        create-admin-user.action.ts    # Server action that executes everything
      hooks/
        use-create-admin-user.ts       # React hook that calls the action
      components/
        create-admin-modal.tsx         # Modal with form and credentials display
        create-admin-button.tsx        # Button that appears in toolbar
```

### Toolbar Integration:

```
app/client/project/[id]/preview/components/toolbar/
  toolbar.tsx                          # Adds <CreateAdminButton />
  actions/
    create-admin-button.tsx            # Conditional button (only shows on /admin)
```

---

## Technical Details

### Generated Script Example:

```typescript
import { auth } from './lib/auth.ts';
import { db } from './db/index.ts';
import { user } from './db/schema.ts';
import { eq } from 'drizzle-orm';

async function createAdmin() {
  try {
    // Check if user already exists
    const existing = await db
      .select()
      .from(user)
      .where(eq(user.email, 'user@behave.com'))
      .limit(1);

    if (existing.length > 0) {
      // Update existing user
      const result = await auth.api.createUser({
        body: {
          email: 'user@behave.com',
          password: 'password123',
          name: 'Admin User',
          role: 'admin',
        },
      });
      console.log('Admin user updated successfully');
      process.exit(0);
    }

    // Create new user
    const result = await auth.api.createUser({
      body: {
        email: 'user@behave.com',
        password: 'password123',
        name: 'Admin User',
        role: 'admin',
      },
    });
    console.log('Admin user created successfully');
    process.exit(0);
  } catch (error) {
    console.error('Error:', error);
    process.exit(1);
  }
}

createAdmin();
```

### Security Considerations

1. **Temporary Script**:

   - Unique filename with timestamp and random string
   - Removed immediately after execution
   - Cleanup attempted even on errors

2. **Authentication**:

   - Action verifies user is authenticated
   - Uses email from logged-in Behave user

3. **Validation**:

   - Minimum 8 character password
   - Password confirmation required

4. **Isolation**:
   - Script runs only in project's sandbox
   - Does not affect other projects

---

## Visual Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Behave - Web-Template Preview     â”‚
â”‚  URL: /admin                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Toolbar: [Admin Access] button     â”‚
â”‚  (only appears when path = /admin)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ (click)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Modal: Create/Reset Admin User    â”‚
â”‚  - Email: user@behave.com           â”‚
â”‚  - Password: [________]             â”‚
â”‚  - Confirm:  [________]             â”‚
â”‚  [Cancel] [Create/Reset Admin]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ (submit)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend Action:                     â”‚
â”‚  1. Validate password               â”‚
â”‚  2. Get project + sandbox            â”‚
â”‚  3. Create temporary script         â”‚
â”‚  4. SSH â†’ write script              â”‚
â”‚  5. SSH â†’ execute script            â”‚
â”‚  6. SSH â†’ remove script             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ (success)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Modal: Credentials                 â”‚
â”‚  Email: [user@behave.com] [ğŸ“‹]      â”‚
â”‚  Pass:  [password123]    [ğŸ“‹]       â”‚
â”‚  âš ï¸ Copy and login at /auth/signin â”‚
â”‚  [Done]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼ (user copies)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Preview: /auth/signin               â”‚
â”‚  (user logs in manually)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Benefits

1. **No Local Scripts**: Everything done via UI
2. **No Manual SSH**: Fully automated
3. **Temporary Script**: Removed after use
4. **Always Available**: Can reset password anytime
5. **Secure**: Uses authenticated user's email
6. **Simple**: Button in toolbar when on `/admin`

---

## Important Notes

1. **Manual Login Required**: User must copy and paste credentials (cookies don't reach browser)
2. **Sandbox Dependency**: Requires active sandbox
3. **Branch**: Defaults to "main" (can be configurable)
4. **Better Auth**: Script uses Better Auth API from web-template

---

## Implementation Summary

- **Where**: Behave, in preview toolbar when viewing `/admin`
- **What**: Button that opens modal to create/reset admin password
- **How**: Creates temporary script in sandbox, executes via SSH, removes it
- **Result**: Shows credentials to copy and use for manual login

---

## Edge Cases

1. **User Already Admin**: Script updates password and role
2. **Sandbox Not Ready**: Show error message
3. **SSH Connection Fails**: Show error, attempt cleanup
4. **Script Execution Fails**: Show error, attempt cleanup
5. **Network Issues**: Handle gracefully with retry logic

---

## Future Enhancements

1. **Magic Link Alternative**: Generate magic link instead of password
2. **Auto-Login**: Iframe postMessage to trigger login (requires cookie sharing)
3. **Password History**: Store last used password (encrypted)
4. **Admin Status Check**: Show if admin already exists before creating
